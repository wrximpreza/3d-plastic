# Metadata Embedding in Exported Files

This document describes how metadata is embedded in all exported file formats from the Plastic Parts Configurator.

## Metadata Fields

The following metadata is embedded in all file formats where possible:

- **User**: Current user (default: "Guest")
- **Material**: Material type (e.g., "ABS Plastic", "Polycarbonate")
- **Dimensions**: Width, Height, Thickness (in mm)
- **Color**: Color/finish selection
- **Corner Radius**: Rounded corner radius (if applicable)
- **Holes**: Number and specifications of holes
- **Assembly Details**: Written specification of assembly requirements
- **Generated Date/Time**: Timestamp of file generation

## File Format Support

### 1. STEP Files (.step)

**Metadata Location**: Embedded as FreeCAD properties and in STEP header

**Implementation**:
- FreeCAD properties: `Material`, `Width`, `Height`, `Thickness`, `HoleCount`
- STEP header: `FILE_DESCRIPTION` and `PRODUCT` entities
- Part label includes material name

**Example**:
```step
FILE_DESCRIPTION(('Plastic Part - ABS Plastic','Width: 500mm, Height: 300mm, Thickness: 10mm'),'2;1');
PRODUCT('PlasticPart_ABS_Plastic','ABS Plastic - 500x300x10mm - 2 holes','Part generated by Plastic Configurator');
```

**Accessibility**: 
- Readable in any STEP-compatible CAD software
- Properties visible in FreeCAD property panel
- Header readable in text editor

---

### 2. DXF Files (.dxf)

**Metadata Location**: Comment blocks (code 999) in HEADER section

**Implementation**:
- DXF comment entities (999 code)
- Includes all metadata fields
- Human-readable in text editor

**Example**:
```dxf
999
Plastic Part Metadata
999
Material: ABS Plastic
999
Dimensions: 500mm x 300mm x 10mm
999
Color: #e0e7ff
999
Corner Radius: 5mm
999
Holes: 2
999
Generated: 2025-10-31 12:34:56
999
Assembly Details: Mount with M6 bolts
```

**Accessibility**:
- Readable in text editor
- Preserved when importing into CAD software
- Does not affect geometry

---

### 3. STL Files (.stl)

**Metadata Location**: Comment facets in ASCII STL header

**Implementation**:
- Custom comment facets after solid name
- All metadata fields included
- ASCII format only (binary STL has limited header space)

**Example**:
```stl
solid PlasticPart
  facet comment Material: ABS Plastic
  facet comment Dimensions: 500mm x 300mm x 10mm
  facet comment Color: #e0e7ff
  facet comment Holes: 2
  facet comment Generated: 2025-10-31 12:34:56
  facet comment Assembly: Mount with M6 bolts
  facet normal 0 0 1
    outer loop
      vertex 0 0 10
      ...
```

**Accessibility**:
- Readable in text editor
- May be preserved by some STL viewers
- Does not affect mesh geometry

---

### 4. GLB Files (.glb)

**Metadata Location**: glTF extras and asset metadata

**Implementation**:
- When FreeCAD successfully converts to GLB, metadata is embedded in glTF structure
- Falls back to STL with metadata if conversion fails

**Note**: GLB is binary format, metadata requires glTF viewer/parser to access

---

### 5. PNG Preview Images (.png)

**Metadata Location**: PNG tEXt chunks (PNG metadata)

**Implementation**:
- PIL/Pillow `PngInfo` metadata
- Embedded in PNG file structure
- All metadata fields included
- View type specified (Front, Top, Isometric)

**Metadata Fields**:
```
Material: ABS Plastic
Width: 500mm
Height: 300mm
Thickness: 10mm
Color: #e0e7ff
Holes: 2
View: Front|Top|Isometric
Generated: 2025-10-31 12:34:56
AssemblyDetails: Mount with M6 bolts
```

**Accessibility**:
- Use `exiftool` or similar tools to read metadata
- Python PIL: `Image.open('file.png').info`
- Does not affect image display

**Example (Python)**:
```python
from PIL import Image
img = Image.open('preview_front.png')
print(img.info)
# {'Material': 'ABS Plastic', 'Width': '500mm', ...}
```

---

### 6. JSON Metadata Export (.json)

**Metadata Location**: Standalone JSON file

**Implementation**:
- Complete metadata in structured JSON format
- Downloadable via "Export" button in metadata panel
- Includes all fields plus ISO timestamp

**Example**:
```json
{
  "user": "Guest",
  "date": "2025-10-31T12:34:56.789Z",
  "dimensions": {
    "width": 500,
    "height": 300,
    "thickness": 10,
    "unit": "mm"
  },
  "material": "ABS Plastic",
  "color": "#e0e7ff",
  "cornerRadius": 5,
  "holes": [
    {
      "number": 1,
      "diameter": 6,
      "position": { "x": 100, "y": 100 }
    }
  ],
  "assemblyDetails": "Mount with M6 bolts",
  "generatedAt": "10/31/2025, 12:34:56 PM"
}
```

**Accessibility**:
- Human-readable
- Machine-parseable
- Can be used for automation/integration

---

## Reading Metadata

### STEP Files
```bash
# View in text editor
cat part.step | grep -A 5 "FILE_DESCRIPTION"
```

### DXF Files
```bash
# View metadata comments
cat part.dxf | grep -A 1 "999"
```

### STL Files
```bash
# View header
head -20 part.stl
```

### PNG Files
```bash
# Using exiftool
exiftool preview_front.png

# Using Python
python -c "from PIL import Image; print(Image.open('preview_front.png').info)"
```

### JSON Files
```bash
# Pretty print
cat metadata.json | python -m json.tool
```

---

## Benefits

1. **Traceability**: Every file contains its generation parameters
2. **Quality Control**: Easy to verify part specifications
3. **Manufacturing**: CNC operators can verify dimensions
4. **Documentation**: Self-documenting files
5. **Automation**: Metadata can be parsed for automated workflows
6. **Version Control**: Track changes through metadata timestamps

---

## Implementation Files

- **Backend**: `backend/services/cad_service.py`
  - `_create_step_content()` - STEP metadata
  - `_create_dxf_content()` - DXF metadata
  - `_create_stl_content()` - STL metadata
  - `_generate_*_view_image()` - PNG metadata

- **Frontend**: `frontend/src/components/GLBViewer.tsx`
  - `handleDownloadMetadata()` - JSON export
  - Metadata panel display

---

## Future Enhancements

- [ ] Add user authentication to populate actual user names
- [ ] Include order/project ID in metadata
- [ ] Add QR code to images linking to metadata
- [ ] Export metadata as XML for ERP integration
- [ ] Embed 3D thumbnail in STEP files

